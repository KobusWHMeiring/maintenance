{% extends "base.html" %}
{% load static %}

{% block title %}Step 5: Claim and Expense Details{% endblock %}

{% block content %}
<div class="wizard-content-wrapper">

    {% include 'wizard/_wizard_tabs.html' %}

    <div class="wizard-form-body">
        <div class="wizard-header">
            <span class="wizard-header__step-counter">Step 5 of 5</span>
            <h2 class="wizard-header__title">The Maintenance Claim</h2>
            <p class="wizard-header__intro">Finally, provide details about the claim and a breakdown of the monthly expenses. Enter '0' if a value is not applicable.</p>
        </div>

        <form method="post" class="form-wizard" novalidate>
            {% csrf_token %}
            {{ form.form_step }}

            {% if form.non_field_errors %}
            <div class="form-errors" role="alert">
                {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
            </div>
            {% endif %}

            <!-- Claim Details Section -->
            <h3 class="mb-3">Claim Details</h3>
            {% include 'wizard/_form_field.html' with field=form.legally_liable_reason %}
            {% include 'wizard/_form_field.html' with field=form.child_in_care_reason %}
            {% include 'wizard/_form_field.html' with field=form.other_contributions_text %}
            <div class="form-grid form-grid--2-col">
                {% include 'wizard/_form_field.html' with field=form.date_not_supported %}
                {% include 'wizard/_form_field.html' with field=form.payment_day %}
            </div>
            {% include 'wizard/_form_field.html' with field=form.payment_made_to %}

            <hr class="my-5">

            <!-- Monthly Expenses Section -->
            <h3 class="mb-3">Monthly Expense Breakdown</h3>
            <p class="text-muted mb-4">Split shared costs between yourself and the child(ren). For expenses that are only for the children (like school uniforms), leave the "Your Share" field blank.</p>

            <div class="expense-table">
                <div class="expense-table__header">
                    <div class="expense-table__label">Expense Category</div>
                    <div class="expense-table__inputs">
                        <div>Your Share (R)</div>
                        <div>Child(ren)'s Share (R)</div>
                    </div>
                </div>

                <h4 class="expense-table__category-title">Household</h4>
                {% include 'wizard/_expense_row.html' with label_text="Lodging (Rent/Bond)" self_field=form.self_lodging child_field=form.child_lodging %}
                {% include 'wizard/_expense_row.html' with label_text="Groceries / Food" self_field=form.self_groceries child_field=form.child_groceries %}
                {% include 'wizard/_expense_row.html' with label_text="Water & Electricity" self_field=form.self_utilities child_field=form.child_utilities %}
                {% include 'wizard/_expense_row.html' with label_text="Rates & Taxes" self_field=form.self_rates_taxes child_field=form.child_rates_taxes %}
                {% include 'wizard/_expense_row.html' with label_text="Laundry / Cleaning" self_field=form.self_laundry child_field=form.child_laundry %}
                {% include 'wizard/_expense_row.html' with label_text="Telephone / Cellphone" self_field=form.self_telephone child_field=form.child_telephone %}

                <h4 class="expense-table__category-title">Clothing</h4>
                {% include 'wizard/_expense_row.html' with label_text="Clothes & Shoes" self_field=form.self_clothing child_field=form.child_clothing %}
                {% include 'wizard/_expense_row.html' with label_text="School Uniforms" child_field=form.child_school_uniforms %}
                {% include 'wizard/_expense_row.html' with label_text="Sports Clothes" child_field=form.child_sports_clothes %}

                <h4 class="expense-table__category-title">Transport</h4>
                {% include 'wizard/_expense_row.html' with label_text="Public Transport / Lift Club" self_field=form.self_transport_public child_field=form.child_transport_public %}
                {% include 'wizard/_expense_row.html' with label_text="Car: Fuel" self_field=form.self_car_fuel child_field=form.child_car_fuel %}
                {% include 'wizard/_expense_row.html' with label_text="Car: Maintenance" self_field=form.self_car_maintenance child_field=form.child_car_maintenance %}
                {% include 'wizard/_expense_row.html' with label_text="Car: Insurance & Installments" self_field=form.self_car_insurance child_field=form.child_car_insurance %}

                <h4 class="expense-table__category-title">Education</h4>
                {% include 'wizard/_expense_row.html' with label_text="School Fees" child_field=form.child_school_fees %}
                {% include 'wizard/_expense_row.html' with label_text="Books & Stationery" child_field=form.child_stationery %}
                {% include 'wizard/_expense_row.html' with label_text="Outings & Extramurals" child_field=form.child_extramural %}

                <h4 class="expense-table__category-title">Medical (uncovered)</h4>
                {% include 'wizard/_expense_row.html' with label_text="Doctor / Dentist" self_field=form.self_medical_uncovered child_field=form.child_medical_uncovered %}
                {% include 'wizard/_expense_row.html' with label_text="Medication" self_field=form.self_medication_uncovered child_field=form.child_medication_uncovered %}

                <h4 class="expense-table__category-title">Other</h4>
                {% include 'wizard/_expense_row.html' with label_text="Holidays & Entertainment" self_field=form.self_entertainment child_field=form.child_entertainment %}
                {% include 'wizard/_expense_row.html' with label_text="Other Significant Expenses" self_field=form.self_other child_field=form.child_other %}

                <div class="expense-table__row expense-table__total-row">
                    <div class="expense-table__label">Calculated Total Child(ren)'s Expenses</div>
                    <div class="expense-table__inputs"><div></div><div id="child-expense-total" class="expense-table__total-value">R 0.00</div></div>
                </div>
            </div>

            <hr class="my-5">
            
            <!-- Final Claim Section -->
            <h3 class="mb-3">Your Formal Claim</h3>
            {% include 'wizard/_form_field.html' with field=form.total_maintenance_claimed %}

            <div class="wizard-form-footer">
                <button type="submit" class="btn btn-primary">
                    Review Application
                    <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form.form-wizard');
    const childTotalElement = document.getElementById('child-expense-total');
    
    // This selector robustly finds all inputs that start with "child_"
    const childExpenseInputs = form.querySelectorAll('input[name^="child_"]');

    function calculateTotal() {
        let total = 0;
        childExpenseInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        // Format as currency
        childTotalElement.textContent = `R ${total.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // Calculate total on page load to initialize it
    calculateTotal();

    // Recalculate whenever any input in the form changes
    form.addEventListener('input', calculateTotal);
});
</script>
{% endblock %}